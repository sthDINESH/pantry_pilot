{% extends 'base.html' %}

{% load static %}

{% load crispy_forms_tags %}

{% block title %}
Pantry
{%endblock title %}

{% block main_content %}
<div id="my-pantry-page" class="split-screen">
    <div class="screen left-screen">
        <div id="pantry-carousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="4000">
            <!-- Carousel slides -->
            <div class="carousel-inner">
                <div class="carousel-item active" data-bs-interval="6000">
                    <img src="{% static 'images/pantry_carousel_dairy.webp' %}" class="d-block w-100 h-100" alt="Pantry organization">
                </div>
                <div class="carousel-item" data-bs-interval="6000">
                    <img src="{% static 'images/pantry_carousel_grains.webp' %}" class="d-block w-100 h-100" alt="Kitchen storage">
                </div>
                <div class="carousel-item" data-bs-interval="6000">
                    <img src="{% static 'images/pantry_carousel_spices.webp' %}" class="d-block w-100 h-100" alt="Food inventory">
                </div>
                <div class="carousel-item" data-bs-interval="6000">
                    <img src="{% static 'images/pantry_carousel_vegetables.webp' %}" class="d-block w-100 h-100" alt="Pantry management">
                </div>
            </div>
        </div>
    </div>
    <div class="screen right-screen">
        <div id="pantry-section" class="section-wrapper">
            <div class="container">
                <div class="section-heading">
                    <h1>My Pantry</h1>
                    <button type="button" class="btn btn-primary circle" data-bs-toggle="collapse"
                        data-bs-target="#pantry-item-form" {% if categories.count %} aria-expanded="false" {% else %}
                        aria-expanded="true" {% endif %} aria-controls="pantry-item-form" data-type="collapse-trigger">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                <p class="section-body-text">Track quantities, organize by category, and stay on top of kitchen
                    inventory.</p>

                <form id="pantry-item-form" method="post" class="collapse {% if not categories.count %}show{% endif %}"
                enctype="multipart/form-data">
                    {% crispy pantry_item_form %}
                    {% crispy category_form %}
                    {% csrf_token %}
                    <div class="form-button-controls">
                        <button id="pantry-submit-button" type="submit" class="btn btn-primary form-button">Add</button>
                    </div>
                </form>
                {% for category in categories %}
                <div id="category-{{ category.id }}" class="category-section">
                    <div class="category-section-heading">
                        <h2 class="sub-heading" data-category-name="{{ category.category_name }}"> {{ category }}
                            <span>,
                                {{ category.pantry_items.count }} item{{ category.pantry_items.count|pluralize }}
                            </span>
                        </h2>
                        <button type="button" class="btn btn-secondary btn-sm circle" data-type="category-delete"
                            data-category-id="{{ category.id }}" data-category="{{ category }}">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button type="button" class="btn btn-info btn-sm circle" data-bs-toggle="collapse"
                            data-bs-target="#category-body-{{ category.id }}" aria-expanded="true"
                            aria-controls="category-body-{{ category.id }}" data-type="collapse-trigger">
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                    </div>
                    <div id="category-body-{{ category.id }}"
                        class="category-section-body row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3 collapse show">
                        {% for pantry_item in category.pantry_items.all %}
                        <div id="item-{{ pantry_item.id }}" class="pantry-item col list-view-card">
                            <div class="card">
                                {% if "placeholder" in pantry_item.image.url %}
                                <img src="{% static 'images/pantry_placeholder.webp' %}" class="card-img-top placeholder-item"
                                    alt="placeholder pantry item">
                                {% else %}
                                <img src="{{ pantry_item.image.url }}" class="card-img-top"
                                    alt="pantry item {{ pantry_item.name }}">
                                {% endif %}
                                <div class="card-body">
                                    <div class="pantry-item-name card-title">{{ pantry_item.name }}</div>
                                    <div class="card-text">
                                        <div class="pantry-item-details">
                                            <div class="pantry-item-quantity">{{ pantry_item.quantity }}</div>
                                            <div class="pantry-item-units" data-item-units="{{ pantry_item.units }}">
                                                {{ pantry_item.get_units_display }}</div>
                                        </div>
                                        <div class="button-controls">
                                            <button type="button" class="btn btn-info btn-sm circle"
                                                data-type="pantry-item-update" data-item-id="{{ pantry_item.id }}"
                                                data-category-id="{{ category.id }}">
                                                <i class="fa-solid fa-pen"></i>
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm circle"
                                                data-type="pantry-item-delete" data-item-id="{{ pantry_item.id }}"
                                                data-item-name="{{ pantry_item.name }}">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% empty %}
                        <p>No items found.</p>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <p>Your pantry is empty. Start by adding items.</p>
                {% endfor %}
            </div>

        </div>
    </div>
</div>

{% if show_duplicate_modal %}
<!-- Duplicate Item Modal -->
<div class="modal fade" id="duplicate-item-modal" tabindex="-1" aria-labelledby="duplicate-item-modal-label"
    aria-hidden="true" data-redirect-url="{% url 'pantry' %}">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="duplicate-item-modal-label">Item Already Exists</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                    <strong>{{ existing_item.name }}</strong> already exists in your pantry.
                </p>
                <div class="row">
                    <div class="col-6">
                        <h6>Current:</h6>
                        <p>{{ existing_item.quantity }} {{ existing_item.get_units_display }}</p>
                        <p>{{ existing_item.category.get_category_name_display }}</p>
                    </div>
                    <div class="col-6">
                        <h6>New:</h6>
                        <p>{{ form_data.quantity }} {{ form_data.units_display }}</p>
                        <p>{{ form_data.category_display }}</p>
                    </div>
                </div>
                <hr>
                <p>How would you like to handle this?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                {% if add_quantity_form %}
                <!-- Update quantity form -->
                <form method="post" action="{% url 'pantry_item_handle' existing_item.id %}" style="display: inline;">
                    {% csrf_token %}
                    {{ add_quantity_form }}
                    <button type="submit" class="btn btn-success">Add to Existing</button>
                </form>
                {% endif %}

                {% if replace_quantity_form %}
                <!-- Replace quantity form -->
                <form method="post" action="{% url 'pantry_item_handle' existing_item.id %}" style="display: inline;">
                    {% csrf_token %}
                    {{ replace_quantity_form }}
                    <button type="submit" class="btn btn-warning">Replace Existing</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock main_content %}

{% block modal_title %}
Delete from pantry?
{% endblock modal_title %}

{% block modal_action %}
<a id="delete-confirm" href="#" class="btn btn-danger">Delete</a>
{% endblock modal_action %}