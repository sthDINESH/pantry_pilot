{% extends 'base.html' %}

{% load static %}

{% load crispy_forms_tags %}

{% block title %}
Recipes
{% endblock title %}

{% block main_content %}
<section id="recipes-page" class="split-screen">
    <div class="screen left-screen">
        <div id="recipes-section" class="section-wrapper">
            <div class="container">
                <div class="section-heading">
                    <h1>Recipes</h1>
                </div>
                <p class="section-body-text"><strong class="sub-heading">Turn your pantry treasures into culinary
                        adventures!</strong>
                    <br>
                    <br>
                    Search by recipes based on ingredients on hand, save your family
                    favorites, and discover the joy of cooking with confidence â€“ because the best recipes start with
                    what's already in your kitchen.
                </p>

                <!-- Recipe search form -->
                <div id="recipe-search-forms" class="container">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="recipes-form-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="discover-tab" data-bs-toggle="tab"
                                data-bs-target="#discover-pane" type="button" role="tab" aria-controls="discover-pane"
                                aria-selected="true">
                                <i class="fa-solid fa-magnifying-glass"></i>
                                <span class="hide">Discover New Recipes</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved-pane"
                                type="button" role="tab" aria-controls="saved-pane" aria-selected="false">
                                <i class="fa-solid fa-bookmark"></i>({{ saved_recipes_json|length }})
                                <span class="hide">View Saved Recipes</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="my-recipes-tab" data-bs-toggle="tab"
                                data-bs-target="#my-recipes-pane" type="button" role="tab"
                                aria-controls="my-recipes-pane" aria-selected="false">
                                <i class="fa-solid fa-book-open-reader"></i>
                                <span class="hide">My Recipes</span>
                            </button>
                        </li>
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content" id="recipes-form-tabContent">
                        <div class="tab-pane fade show active" id="discover-pane" role="tabpanel"
                            aria-labelledby="discover-tab" tabindex="0">
                            <div class="p-2 p-md-4">
                                <p><strong>Ready to create something amazing?</strong>
                                    <br>
                                    <br>
                                    Choose what you fancy and find perfect recipes to match based on ingredients
                                    already on hand!
                                </p>
                                <form action="{% url 'recipes' %}" method="POST" id="recipe-search-form">
                                    {% crispy recipe_search_form %}
                                    <div class="form-button-controls">
                                        <button type="submit" class="btn btn-primary form-button">Search</button>
                                    </div>
                                </form>

                                <!-- Search results list will be added here -->
                                <div class="container">
                                    <div id="recipe-search-results" class="category-section">
                                        <div class="category-section-heading">
                                            <h2 class="sub-heading">Search Results</h2>
                                        </div>
                                        <div class="category-section-body row row-cols-1 row-cols-md-2 g-3">
                                            {% if search_results %}
                                            {% if search_results.response.success %}
                                            {% for recipe in search_results.response.recipes %}
                                            <div class="recipe-item col list-view-card">
                                                <div class="card">
                                                    <img src="{{ recipe.image }}" class="card-img-top"
                                                        alt="Image for {{ recipe.title }}">
                                                    <div class="card-body">
                                                        <div class="recipe-title card-title">
                                                            {{ recipe.title }}
                                                            {% if recipe.saved %}
                                                            <br>
                                                            <small class="text-success">
                                                                <i class="fa-solid fa-bookmark"></i> Saved
                                                            </small>
                                                            {% endif %}
                                                        </div>
                                                        <div class="card-text">
                                                            <div class="recipe-details">
                                                                <em>
                                                                    Ingredients:
                                                                    <span>
                                                                        {{ recipe.missing_ingredients_count }} missing
                                                                    </span>
                                                                    ,
                                                                    <span>
                                                                        {{ recipe.matched_ingredients_count }} in pantry
                                                                    </span>
                                                                </em>
                                                                <button type="button"
                                                                    class="btn btn-secondary btn-sm circle"
                                                                    data-type="ingredients-count-info"
                                                                    data-api-recipe-id="{{ recipe.api_recipe_id }}">
                                                                    <i class="fa-solid fa-info"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="button-controls">
                                                            {% if recipe.saved %}
                                                            <a href="{% url 'saved_recipe_detail' recipe.id %}?from=discover"
                                                                class="btn btn-info">
                                                                View
                                                            </a>
                                                            {% else %}
                                                            <a href="{% url 'recipe_detail' recipe.api_recipe_id %}?from=discover"
                                                                class="btn btn-info">
                                                                View
                                                            </a>
                                                            <a href="{% url 'recipe_save' recipe.api_recipe_id %}?from=discover"
                                                                class="btn btn-primary">
                                                                Save
                                                            </a>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% empty %}
                                            <p>
                                                No matching results found - Try something different or check saved
                                                recipes.
                                            </p>

                                            {% endfor %}
                                            {% else %}
                                            <p>
                                                Apologies - some error occurred during search! Try again later or check
                                                saved recipes.
                                            </p>
                                            {% endif %}
                                            {% else %}
                                            <p class="text-muted">Start searching for recipes!</p>
                                            {% endif %}
                                        </div>

                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="saved-pane" role="tabpanel" aria-labelledby="saved-tab"
                            tabindex="0">
                            <div class="p-2 p-md-4">
                                <!-- Saved recipes listed here -->
                                <div class="container">
                                    <div id="saved-recipes" class="category-section">
                                        <div class="category-section-heading">
                                            <h2 class="sub-heading">
                                                Saved Recipes
                                                <span>
                                                    , {{ saved_recipes_json|length }} available
                                                </span>
                                            </h2>
                                        </div>
                                        <div class="category-section-body row row-cols-1 row-cols-md-2 g-3">
                                            {% if saved_recipes_json %}
                                            {% for recipe in saved_recipes_json %}
                                            <div class="recipe-item col list-view-card">
                                                <div class="card">
                                                    <img src="{{ recipe.image }}" class="card-img-top"
                                                        alt="Image for {{ recipe.title }}">
                                                    <div class="card-body">
                                                        <div class="recipe-title card-title">{{ recipe.title }}</div>
                                                        <div class="card-text">
                                                            <div class="recipe-details">
                                                                <em>
                                                                    Ingredients:
                                                                    <span>
                                                                        {{ recipe.missing_ingredients|length }} missing,
                                                                    </span>
                                                                    ,
                                                                    <span>
                                                                        {{ recipe.matched_ingredients|length }} in
                                                                        pantry
                                                                    </span>
                                                                </em>
                                                                <button type="button"
                                                                    class="btn btn-secondary btn-sm circle"
                                                                    data-type="ingredients-count-info"
                                                                    data-recipe-id="{{ recipe.id }}">
                                                                    <i class="fa-solid fa-info"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="button-controls">
                                                            <a href="{% url 'saved_recipe_detail' recipe.id %}?from=saved"
                                                                class="btn btn-info">View</a>
                                                            <button class="btn btn-secondary" data-type="recipe-delete"
                                                                data-recipe-id="{{ recipe.id }}"
                                                                data-recipe-title="{{ recipe.title }}">Delete</button>
                                                        </div>
                                                        <form method="post"
                                                            action="{% url 'toggle_recipe_selection' recipe.id %}?from=saved">
                                                            {% csrf_token %}
                                                            {% if recipe.id|stringformat:"s" in selected_for_meal_plan%}
                                                            <button type="submit" class="btn"
                                                                data-type="toggle-meal-selection"
                                                                data-recipe-id="{{ recipe.id }}">
                                                                <i class="fa-solid fa-check"></i> Selected (Remove)
                                                            </button>
                                                            {% else %}
                                                            <button type="submit" class="btn"
                                                                data-type="toggle-meal-selection"
                                                                data-recipe-id="{{ recipe.id }}">
                                                                <i class="fa-solid fa-calendar-plus"></i> Select for
                                                                Meal Plan
                                                            </button>
                                                            {% endif %}
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            {% empty %}
                                            <p>
                                                No matching results found - Try something different or check saved
                                                recipes.
                                            </p>

                                            {% endfor %}
                                            {% else %}
                                            <p class="text-muted">No saved recipes found - Search for recipes and save
                                                your favorites.</p>
                                            {% endif %}
                                        </div>

                                    </div>

                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="my-recipes-pane" role="tabpanel" aria-labelledby="my-recipes-tab"
                            tabindex="0">
                            <div class="p-2 p-md-4">
                                <!-- Your shopping list content here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="screen right-screen">
        <div class="carousel-container">
            <div id="recipe-carousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#recipe-carousel" data-bs-slide-to="0" class="active"
                        aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#recipe-carousel" data-bs-slide-to="1"
                        aria-label="Slide 2"></button>
                    <button type="button" data-bs-target="#recipe-carousel" data-bs-slide-to="2"
                        aria-label="Slide 3"></button>
                </div>
                <div class="carousel-inner">
                    <div class="carousel-item active" data-bs-interval="5000">
                        <img src="{% static 'images/recipes.webp'%}" class="d-block w-100" alt="...">
                        <div class="carousel-caption d-block">
                            <p>Discover new recipes based on what's in your pantry</p>
                        </div>
                    </div>
                    <div class="carousel-item" data-bs-interval="5000">
                        <img src="{% static 'images/favorite_recipe.webp'%}" class="d-block w-100" alt="...">
                        <div class="carousel-caption d-block">
                            <p>Save your favorite recipes from searches</p>
                        </div>
                    </div>
                    <div class="carousel-item" data-bs-interval="5000">
                        <img src="{% static 'images/family_recipes.webp'%}" class="d-block w-100" alt="...">
                        <div class="carousel-caption d-block">
                            <p>Save those recipes passed down through generations to your own recipe book</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="section-image">
        </div>
    </div>
</section>
{% endblock main_content %}

<!-- Pop-up modal to display matched/missing ingredients for recipe
Use base modal -->
<!-- Dump search results as json for js interactivity  -->
{% block json_data %}
{% if search_results.response.success %}
{{ search_results.response.recipes|json_script:"search-data" }}
{{ saved_recipes_json|json_script:"saved-recipes-data" }}
{% endif %}
{% endblock json_data%}